<!doctype html>
<html>
  <head>
    <title>Add Patient</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h2>Add Patient</h2>

      <form id="addForm">
        <div class="mb-3">
          <label>Name</label>
          <input type="text" id="name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Guardian</label>
          <input type="text" id="guardian" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Mobile</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input
              type="text"
              id="mobile"
              class="form-control"
              maxlength="10"
              placeholder="Enter 10 digit mobile number"
              required
            />
          </div>
          <small id="mobileError" class="text-danger"></small>
        </div>

        <div class="mb-3">
          <label>Admission Date</label>
          <input type="date" id="admissionDate" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Addiction Type</label>
          <input type="text" id="addictionType" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Pickup Type</label>
          <select
            id="pickupType"
            class="form-control"
            onchange="toggleDistance()"
          >
            <option value="Self">Self</option>
            <option value="Pickup">Pickup</option>
          </select>
        </div>

        <div class="mb-3" id="distanceContainer" style="display: none">
          <label>Distance (KM)</label>
          <input
            type="number"
            id="distance"
            class="form-control"
            placeholder="Enter distance in KM"
          />
        </div>

        <div class="mb-3">
          <label>Total Fees</label>
          <input type="number" id="totalFees" class="form-control" required />
        </div>

        <button type="submit" class="btn btn-primary">Add Patient</button>
        <a href="patients.html" class="btn btn-secondary">Cancel</a>
      </form>
    </div>

    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "index.html";
      }

      document
        .getElementById("addForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!validateMobile()) return;

          const data = {
            name: document.getElementById("name").value,
            guardian: document.getElementById("guardian").value,
            mobile: document.getElementById("mobile").value,
            admissionDate: document.getElementById("admissionDate").value,
            addictionType: document.getElementById("addictionType").value,
            totalFees: document.getElementById("totalFees").value,
            pickupType: document.getElementById("pickupType").value,
            distance: document.getElementById("distance").value || 0,
          };

          const response = await fetch(
            "https://nmk-system.onrender.com/add-patient",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(data),
            },
          );

          if (response.ok) {
            alert("Patient added successfully");
            window.location.href = "patients.html";
          } else {
            alert("Failed to add patient");
          }
        });

      // Allow only digits while typing
      document.getElementById("mobile").addEventListener("input", function () {
        this.value = this.value.replace(/[^0-9]/g, "");
      });

      function validateMobile() {
        const mobile = document.getElementById("mobile").value.trim();
        const error = document.getElementById("mobileError");

        if (mobile.length !== 10) {
          error.innerText = "Mobile number must be exactly 10 digits";
          return false;
        }

        if (/^0+$/.test(mobile)) {
          error.innerText = "Invalid mobile number";
          return false;
        }

        error.innerText = "";
        return true;
      }
      function toggleDistance() {
        const pickupType = document.getElementById("pickupType").value;
        const container = document.getElementById("distanceContainer");

        if (pickupType === "Pickup") {
          container.style.display = "block";
        } else {
          container.style.display = "none";
          document.getElementById("distance").value = "";
        }
      }
    </script>
  </body>
</html>
