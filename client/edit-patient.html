<!doctype html>
<html>
  <head>
    <title>Edit Patient</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <h2>Edit Patient</h2>

      <form id="editForm">
        <div class="mb-3">
          <label>Name</label>
          <input type="text" id="name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Guardian</label>
          <input type="text" id="guardian" class="form-control" required />
        </div>

        <div class="mb-3">
          <label>Mobile</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input
              type="text"
              id="mobile"
              class="form-control"
              maxlength="10"
              required
            />
          </div>
          <small id="mobileError" class="text-danger"></small>
        </div>

        <div class="mb-3">
          <label>Total Fees</label>
          <input type="number" id="totalFees" class="form-control" required />
        </div>

        <button type="submit" class="btn btn-primary">Update</button>
        <a href="patients.html" class="btn btn-secondary">Cancel</a>
      </form>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const params = new URLSearchParams(window.location.search);
      const patientId = params.get("id");

      if (!token) {
        window.location.href = "index.html";
      }

      // Load patient data
      async function loadPatient() {
        const response = await fetch(
          "https://nmk-system.onrender.com/patients",
          {
            headers: { Authorization: "Bearer " + token },
          },
        );

        const data = await response.json();
        const patient = data.patients.find((p) => p.id === patientId);

        if (!patient) {
          alert("Patient not found");
          window.location.href = "patients.html";
        }

        document.getElementById("name").value = patient.name;
        document.getElementById("guardian").value = patient.guardian;
        document.getElementById("mobile").value = patient.mobile;
        document.getElementById("totalFees").value = patient.totalFees;
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!validateMobile()) return;

          const updatedData = {
            name: document.getElementById("name").value,
            guardian: document.getElementById("guardian").value,
            mobile: document.getElementById("mobile").value,
            totalFees: document.getElementById("totalFees").value,
          };

          const response = await fetch(
            `https://nmk-system.onrender.com/patients/${patientId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(updatedData),
            },
          );

          if (response.ok) {
            alert("Patient updated successfully");
            window.location.href = "patients.html";
          } else {
            alert("Update failed");
          }
        });
      // Allow only digits while typing
      document.getElementById("mobile").addEventListener("input", function () {
        this.value = this.value.replace(/[^0-9]/g, "");
      });

      function validateMobile() {
        const mobile = document.getElementById("mobile").value.trim();
        const error = document.getElementById("mobileError");

        if (mobile.length !== 10) {
          error.innerText = "Mobile number must be exactly 10 digits";
          return false;
        }

        if (/^0+$/.test(mobile)) {
          error.innerText = "Invalid mobile number";
          return false;
        }

        error.innerText = "";
        return true;
      }
      loadPatient();
    </script>
  </body>
</html>
